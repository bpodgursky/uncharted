<!DOCTYPE html>
<html lang="en">
<head>
  <title>Solar Neighorhood</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <link rel="stylesheet" type="text/css" href="resources/css/jquery-ui.css">
  <link rel="stylesheet" type="text/css" href="css/uncharted.css">

  <script type="text/javascript" src="resources/jquery-2.0.0.min.js"></script>
  <script type="text/javascript" src="resources/tinycolor-min.js"></script>
  <script type="text/javascript" src="resources/jquery-ui.min.js"></script>
  <!--<script type="text/javascript" src="resources/css/bootstrap.min.css"></script>-->
  <script src="resources/three.min.js"></script>
  <script src="resources/stats.js"></script>
  <!--<script src="resources/bootstrap.min.js"></script>-->
  <script src="js/constants.js"></script>
  <script src="js/FreeLookControls.js"></script>
  <script src="js/OrbitControls.js"></script>
  <script src="js/DynamicMarker.js"></script>
  <script src="js/TweenControls.js"></script>
  <script src="js/TooltipMarker.js"></script>
  <script src="js/System.js"></script>
  <script src="js/Shaders.js"></script>
  <script src="js/CircularQueue.js"></script>
  <script src="js/RollingAverage.js"></script>
  <script src="resources/Detector.js"></script>

</head>

<body>

<div>
  <div id="selector">
    <h3><span id="info-header" class="accordion-header"></span><b> - <span id="distance-header"
                                                                           class="accordion-header"></span></b></h3>
    <div class="overlay-panel">
      <table>
        <tbody id="info-table"></tbody>
      </table>
    </div>

    <h3>Explore</h3>
    <div class="overlay-panel">
      <div class="ui-widget">
        <label for="jump_to_list">Search: </label>
        <input id="jump_to_list" type="text">
      </div>

    </div>

    <h3>Controls</h3>
    <div class="overlay-panel">
      <table>
        <tbody>

        <tr class="header-row">
          <td>
            <b>Control Mode</b>
          </td>
        </tr>

        <tr class="child-row">
          <td>
            <form id="control_mode" name="control_mode" action="#" method="POST">
              <div>
                <label>
                  <input type="radio" name="control_mode" value="orbit" checked>
                </label> Orbit
                <label>
                  <input type="radio" name="control_mode" value="free">
                </label> Free Look
              </div>
            </form>
          </td>
        </tr>

        <tr class="header-row">
          <td>
            <b>Render Radius (lys)</b>
          </td>
        </tr>

        <tr class="child-row">
          <td>
            <form id="render_radius" name="render_radius" action="#" method="POST">
              <div>
                <label>
                  <input type="radio" name="render_radius" value="10">
                </label> 10
                <label>
                  <input type="radio" name="render_radius" value="25">
                </label> 25
                <label>
                  <input type="radio" name="render_radius" value="50" checked>
                </label> 50
                <label>
                  <input type="radio" name="render_radius" value="75" checked>
                </label> 75
              </div>
            </form>
          </td>
        </tr>


        </tbody>
      </table>
    </div>

  </div>

  <div id="attribution-overlay">
    <a href="https://github.com/bpodgursky/uncharted">Source and project info</a><br>
    <a href="http://bpodgursky.com/">Ben Podgursky</a>
  </div>

  <canvas id='webgl_canvas'></canvas>
</div>

<script>
  //  TODO use size of star

  //  $("#info-header").click(function(e){
  //    console.log("asdf");
  //    e.preventDefault();
  //  });

  var stats = new Stats();
  stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
  //  $("#attribution-overlay").append(stats.dom);

  $(function () {
    $("#selector").accordion({
      collapsible: true,
      animate: 100
    });
  });

  $("#selector").click(function(e){
    e.preventDefault();
  });

  var distanceHeader = $("#distance-header");
  var lastDistance;

  if (!Detector.webgl) Detector.addGetWebGLMessage();

  //  constant stuff

  var SURROUND_GEOMETRY = new THREE.SphereGeometry(1.0, 8, 8);

  //  webgl init


  var canvas = $("#webgl_canvas").get(0);

  var scene = new THREE.Scene();

  var camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.00000000005, 10000);
  camera.position.set(0, 0, -15);
  camera.rotateZ(Math.PI);

  var intersectCamera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, .01, 10000);

  var windowHalfX = window.innerWidth / 2;
  var windowHalfY = window.innerHeight / 2;

  var clock = new THREE.Clock();

  //  kind of cheating since we know the sun is here
  var solMarker = new DynamicMarker(
      new THREE.Vector3(0, 0, 0),
      SOL_MARKER_RADIUS,
      0x0000FF,
      0
  );

  var selector = new DynamicMarker(
      new THREE.Vector3(0, 0, 0),
      MARKER_RADIUS,
      0x00b33c,
      Math.PI / 4
  );

  var lineMaterial = new THREE.LineBasicMaterial({
    color: 0x0000ff,
    depthWrite: false
  });

  var uniforms = {
    time: {type: "f", value: 1.0},
    scale: {type: "f", value: 80}
  };

  var lineSegment;

  var tooltip;
  var tooltipObject;
  var font;

  var mouseX;
  var mouseY;
  var mouseMoved = false;

  var controlMode = '';

  var renderer = new THREE.WebGLRenderer({
    canvas: canvas,
    logarithmicDepthBuffer: true
  });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.autoClear = true;

  var raycaster = new THREE.Raycaster();
  var mouse = new THREE.Vector2();

  var freeLookControls = new THREE.FreeLookControls(camera, canvas);
  var orbitControls = new THREE.OrbitControls(camera, canvas);
  var tweenControls = new THREE.TweenControls(camera);

  var shaders = new Shaders();

  scene.add(camera);
  scene.add(intersectCamera);
  scene.add(solMarker.mesh);
  scene.add(selector.mesh);

  //  other data

  var starData;
  var planetData;

  var stars = [];
  var starsByID = {};
  var planetsByStarID = {};
  var visibleStars = [];
  var visibleStarsByName = {};
  var renderRadius = 75;


  $("#jump_to_list").keydown(function (e) {
    if (e.keyCode == 13) {
      e.preventDefault();
      select(visibleStarsByName[this.value]);
    }
  });

  $("#render_radius").click(function (e) {
    renderRadius = $('input[name=render_radius]:checked', '#render_radius').val();
    updateobjectData();
  });

  $('#control_mode').click(function (e) {
    controlMode = $('input[name=control_mode]:checked', '#control_mode').val();
    updateTarget();
  });

  $("#info").click(function (e) {
    e.preventDefault();
  });

  function updateTarget(prevStarMesh) {

    var prevControlMode = controlMode;
    controlMode = 'tween';

    tweenControls.setZoom(currentObjectMesh.position, MARKER_RADIUS, 2,
        function () {
          tweenControls.setZoom(currentObjectMesh.position,
              currentObjectMesh.objectData.radius.value.quantity * 10, 1,
              function () {

                if (isStar(prevStarMesh)) {
                  prevStarMesh.objectData.nearbyObjectIDs.forEach(function (e) {
                    resetStarScale(starsByID[e]);
                  })
                }

                if (!prevControlMode || prevControlMode == 'tween') {
                  controlMode = 'orbit';
                } else {
                  controlMode = prevControlMode
                }

                orbitControls.orbit(
                    currentObjectMesh.position,
                    currentObjectMesh.objectData.radius.value.quantity * 2
                )

              }
          )
        });

  }

  function isStar(mesh) {
    return mesh && mesh.objectData.type == "STAR";
  }

  var currentObjectPrimaryId = "";
  var currentObjectMesh;
  var currentSystem;

  //  infobox stuff
  var infoProperName = $("#proper_name_box");
  var infoBayerFlamteed = $("#bayer_flamsteed_box");
  var infoGliese = $("#gliese_catalog_box");
  var infoHarvard = $("#harvard_revised_box");
  var infoHipparcos = $("#hipparcos_box");
  var infoHenryDraper = $("#henry_draper_box");
  var infoSpectralType = $("#spectral-type");
  var infoAbsMagnitude = $("#abs-magnitude");
  var infoDistance = $("#distance_box");
  var infoRightAscension = $("#right_ascension_box");
  var infoDeclination = $("#declination_box");
  var infoWiki = $("#wiki_box");

  infoWiki.click(function (e) {
    window.open(infoWiki.attr('href'), '_blank');
  });

  function getLabelText(identifiers) {

    if (identifiers.properName) {
      return identifiers.properName;
    }

    if (identifiers.glieseId) {
      return identifiers.glieseId;
    }

    if (identifiers.harvardRevisedId) {
      return identifiers.harvardRevisedId;
    }

    if (identifiers.henryDraperId) {
      return identifiers.henryDraperId;
    }

    if (identifiers.hipparcosId) {
      return identifiers.hipparcosId;
    }

  }

  function reassignLabel(targetMesh) {

    if (!tooltipObject || tooltipObject.objectData.primaryId == targetMesh.objectData.primaryId) {
      return;
    }

    doReassign(targetMesh);

  }

  var labelCache = {};

  function doReassign(targetMesh) {

    tooltipObject = targetMesh;

    scene.remove(lineSegment);
    if (tooltip) {
      scene.remove(tooltip.object);
    }

    var targetPos = targetMesh.position;

    var geometry = new THREE.Geometry();
    geometry.vertices.push(currentObjectMesh.position);
    geometry.vertices.push(targetPos);
    lineSegment = new THREE.Line(geometry, lineMaterial);

    var lineDistance = currentObjectMesh.position.distanceTo(targetPos);
    var label = targetMesh.objectData.properName;
    var cacheKey = label + lineDistance;  // could target each star from each other star.

    if (!labelCache[(cacheKey)]) {
      labelCache[cacheKey] = new TooltipMarker(label, prettyDistance(lineDistance), targetMesh.objectData.radius.value.quantity);
    }

    tooltip = labelCache[cacheKey];
    tooltip.object.position.set(
        targetPos.x,
        targetPos.y,
        targetPos.z
    );

    scene.add(lineSegment);
    scene.add(tooltip.object);

    tooltip.updateTo(camera);

  }

  function isRender(objectData) {

    if (objectData.solDistance.value.quantity < renderRadius) {
      return true;
    }
    return false;
  }

  function updateobjectData() {

    var renderedStars = {};
    visibleStars.forEach(function (e) {
      renderedStars[e.objectData.primaryId] = true;
    });
    visibleStars = [];
    visibleStarsByName = {};

    var nameList = [];

    stars.forEach(function (starMesh) {
      var data = starMesh.objectData;
      var starID = data.primaryId;
      var commonName = data.properName;
      nameList.push(commonName);
      visibleStarsByName[commonName] = starMesh;

      if (isRender(data)) {
        visibleStars.push(starMesh);
        if (!renderedStars[starID]) {
          scene.add(starMesh);
        }
      } else {
        if (renderedStars[starID]) {
          scene.remove(starMesh);
        }
      }
    });

    if (currentObjectPrimaryId == "") {
      select(starsByID[15472]);
      reassignLabel(starsByID[70667]);
    }
    //  if we shrunk the render distance
    else if (!renderedStars[currentObjectPrimaryId]) {
      select(starsByID[15472]);
    }


    $("#jump_to_list").autocomplete({
      source: nameList
    });

  }

  function lastNonPrimaryObject(intersects, currentPrimary) {
    if (intersects.length > 0) {
      var lastObject = intersects[intersects.length - 1].object;

      if (lastObject.objectData.primaryId != currentPrimary) {
        return lastObject;
      }

      if (intersects.length > 1) {
        return intersects[intersects.length - 2].object
      }

      return null;
    }
  }


  function getStarForPoint(x, y) {

    if (x && y) {

      mouse.x = ( x / window.innerWidth ) * 2 - 1;
      mouse.y = -( y / window.innerHeight ) * 2 + 1;

      intersectCamera.position.copy(camera.position);
      intersectCamera.rotation.copy(camera.rotation);

      raycaster.setFromCamera(mouse, intersectCamera);


      if (currentSystem) {
        var last = lastNonPrimaryObject(raycaster.intersectObjects(currentSystem.selectable, false), currentObjectPrimaryId);
        if (last) {
          return currentSystem.objectsByID[last.objectData.primaryId];
        }
      }

      var lastStar = lastNonPrimaryObject(raycaster.intersectObjects(visibleStars, false), currentObjectPrimaryId);

      if (lastStar) {
//        var primaryId = lastStar.objectData.primaryId;
        return lastStar;
      }

      if (tooltip) {
        var text = raycaster.intersectObjects(tooltip.scaleObj.children, false);
        if (text.length > 0) {
          return tooltipObject;
        }
      }

    }

    return null;
  }

  function setMouseXY(event) {
    mouseX = event.clientX;
    mouseY = event.clientY;
    mouseMoved = true;
  }

  function consumeMouseMove() {
    if (!mouseMoved) {
      return false
    }

    mouseMoved = false;

    return true;
  }

  function getMouseoverStar() {
    if (!freeLookControls.dragView && consumeMouseMove()) {
      var object = getStarForPoint(mouseX, mouseY);

      if (object) {
        reassignLabel(object);
        canvas.style.cursor = 'pointer';
      } else {
        canvas.style.cursor = 'auto';
      }

    }
  }

  function onMouseClick(event) {

    var diffX = Math.abs(mouseDownX - event.clientX);
    var diffY = Math.abs(mouseDownY - event.clientY);
    var delta = Math.sqrt(Math.pow(diffX, 2) + Math.pow(diffY, 2));

    if (delta < 5) {
      select(getStarForPoint(event.clientX, event.clientY));
    }

  }

  function initializeobjectData() {

    starData.forEach(function (star) {

          var shaderSurround = new THREE.ShaderMaterial({
            vertexShader: shaders.coronaVertexShader,
            fragmentShader: shaders.coronaFragmentShader,
            uniforms: {
              scale: {type: "f", value: 0.0}, //  will set later
              temp: {type: "f", value: star.temperatureEstimate.value.quantity / 2}
            },
            transparent: true
          });

          var surround = new THREE.Mesh(SURROUND_GEOMETRY, shaderSurround);
          surround.objectData = star;
          resetStarScale(surround);

          surround.position.x = star.cartesianCoordsInLys.x;
          surround.position.y = star.cartesianCoordsInLys.y;
          surround.position.z = star.cartesianCoordsInLys.z;

          surround.objectData = star;

          starsByID[star.primaryId] = surround;
          stars.push(surround);
          planetsByStarID[star.primaryId] = [];
        }
    );

    planetData.forEach(function (planet) {
      var star = planet.starId;
      planetsByStarID[star].push(planet);
    });

  }


  function select(mesh) {

    if (mesh) {

      //  TODO flesh out with more fields
      //     # planets (display them?)

      var newTarget = mesh.objectData;

      if (mesh.objectData.type == "STAR") {
        var newCenter = mesh.position;

        var deltaX = newCenter.x;
        var deltaY = newCenter.y;
        var deltaZ = newCenter.z;

        //  TODO only if new system
        scene.children.forEach(function (e) {
          e.position.x -= deltaX;
          e.position.y -= deltaY;
          e.position.z -= deltaZ;
        });

      }

//      mesh.updateMatrix();

      if (newTarget != null) {
        var newTargetPrimaryId = newTarget.primaryId;

        if (newTargetPrimaryId != currentObjectPrimaryId) {

          $('#info-header').text(newTarget.properName);

          var infoTable = $('#info-table');
          infoTable.empty();

          infoTable
              .append(row("Radius", newTarget, 'radius'));

          if (newTarget.type == "STAR") {

            if (currentSystem) {
              scene.remove(currentSystem.object);
            }

            currentSystem = new System(mesh, mesh.position, planetsByStarID[newTarget.primaryId]);
            scene.add(currentSystem.object);

            selector.target(mesh.position);

          } else {

            infoTable
                .append(row("Mass", newTarget, 'massKg'))
                .append(row("Density", newTarget, 'densityGcc'))
                .append(row("Orbital Period", newTarget, 'orbitalPeriodDays'))
                .append(row("Semi-Major axis", newTarget, 'semiMajorAxisLys'))
                .append(row("Semi-Minor axis", newTarget, 'semiMinorAxisLys'))


          }

          var prevTargetMesh = currentObjectMesh;

          currentObjectMesh = mesh;
          currentObjectPrimaryId = newTargetPrimaryId;


          updateTarget(prevTargetMesh);

          doReassign(currentObjectMesh);

        }
      }


    }


  }

  function row(name, data, element) {
    return $('<tr></tr>')
        .append($('<td></td>').text(name))
        .append($('<td></td>').text(getValue(data, element)).addClass('info-element'))
  }

  function getValue(data, element) {
    var elem = data[element];

    //  just a value
    if (!elem.source) {
      return elem;
    }

    if (elem.source == "DEFAULT") {
      return "?";
    }

    return formatObjValue(elem.value);
  }

  function formatObjValue(objValue) {
    if (objValue.unit == 'LY') {
      return prettyDistance(objValue.quantity);
    } else if(objValue.unit == 'DAY'){
      return objValue.quantity+' days';
    } else if(objValue.unit == 'KG'){
      return prettyMass(objValue.quantity);
    }
  }

  function prettyMass(mass){
    return (mass / 5.9722e24).toLocaleString('en-US', {maximumSignificantDigits: 3}) +' MâŠ•'
  }

  function prettyDistance(lys) {
    if (lys > .01) {
      return lys.toFixed(2) + ' ly';
    }

    var distKM = lys * 9.461e12;
    var distAU = distKM / 1.496e8;

    if(distAU > .01){
      return distAU.toLocaleString('en-US', {maximumSignificantDigits: 3}) + ' AU';
    }

    return distKM.toLocaleString('en-US', {maximumSignificantDigits: 3}) + ' km'
  }

  function onWindowResize() {
    windowHalfX = window.innerWidth / 2;
    windowHalfY = window.innerHeight / 2;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    render();
  }

  function animate() {
    stats.begin();
    render();
    stats.end();

    requestAnimationFrame(animate);

  }

  function render() {

    var delta = clock.getDelta();
    uniforms.time.value += 0.003 * delta;

    if (controlMode == 'orbit') {
      orbitControls.update(delta);
    } else if (controlMode == 'free') {
      freeLookControls.update(delta);
    } else if (controlMode == 'tween') {
      tweenControls.update(delta);
    }

    getMouseoverStar();

    if (tooltip) {
      tooltip.updateTo(camera);
    }

    selector.updateTo(camera, delta);
    solMarker.updateTo(camera, delta);

    if (currentSystem) {
      var star = currentSystem.star;

      star.objectData.nearbyObjectIDs.forEach(function (e) {
        var nearStar = starsByID[e];
        var distance = camera.position.distanceTo(nearStar.position) * .2;
        var childUniform = nearStar.material.uniforms;
        if (childUniform.scale.value != distance) {
          var scale = Math.min(distance, nearStar.objectData.radius.value.quantity * 3000000);
          setStarScale(nearStar, scale);
        }

      });

    }

    if (currentObjectMesh) {
      var newDistance = prettyDistance(camera.position.distanceTo(currentObjectMesh.position));
      if (lastDistance != newDistance) {
        lastDistance = newDistance;
        distanceHeader.text(newDistance);
      }
    }

    renderer.render(scene, camera);

  }

  function setStarScale(star, scale) {
    star.material.uniforms.scale.value = scale;
    star.scale.x = star.scale.y = star.scale.z = scale;
  }

  function resetStarScale(star) {
    star.material.uniforms.scale.value = star.objectData.radius.value.quantity * 3000000;
    var scale = 7.35355e-8 * 8000000;
    star.scale.set(scale, scale, scale);
  }

  canvas.addEventListener('contextmenu', function (event) {
    event.preventDefault();
  }, false);

  canvas.addEventListener('mousemove',
      bind(orbitControls.onMouseMove, freeLookControls.onMouseMove),
      false
  );

  canvas.addEventListener('mousedown',
      bind(orbitControls.onMouseDown, freeLookControls.onMouseDown),
      false
  );

  canvas.addEventListener('mousewheel',
      bind(orbitControls.onMouseWheel, freeLookControls.onMouseWheel),
      false
  );

  canvas.addEventListener('DOMMouseScroll',
      bind(orbitControls.onMouseWheel, freeLookControls.onMouseWheel),
      false
  ); // firefox

  canvas.addEventListener('mouseup',
      bind(orbitControls.onMouseUp, freeLookControls.onMouseUp),
      false
  );

  canvas.addEventListener('keydown',
      bind(orbitControls.onKeyDown, freeLookControls.onKeyDown),
      false
  );

  canvas.addEventListener('keyup',
      bind(orbitControls.onKeyUp, freeLookControls.onKeyUp),
      false
  );

  function bind(orbitFn, freeFn) {
    return function () {
      if (controlMode === 'free') {
        freeFn.apply(freeLookControls, arguments);
      } else if (controlMode === 'orbit') {
        orbitFn.apply(orbitControls, arguments);
      }
    };
  }

  var mouseDownX = 0;
  var mouseDownY = 0;

  function setmouseDown(event) {
    mouseDownX = event.clientX;
    mouseDownY = event.clientY;
  }

  window.addEventListener('resize', onWindowResize, false);
  canvas.addEventListener('mousemove', setMouseXY, false);
  canvas.addEventListener('mousedown', setmouseDown, false);
  canvas.addEventListener('mouseup', onMouseClick, false);

  var loader = new THREE.FontLoader();

  $.when(
      $.ajax({
            type: 'GET',
            dataType: 'html',
            url: "star_catalog",
            data: {
              "max_lys": 75
            },
            success: function (data) {
              var dataParsed = JSON.parse(data);
              starData = dataParsed.stars;
              planetData = dataParsed.planets;
            }
          },
          shaders.loaders())
  ).then(function () {
    loader.load('js/font.js', function (response) {
          font = response;
          initializeobjectData();
          animate();
          updateobjectData();
        }
    );
  });

</script>

<script>


  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
    a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

  ga('create', 'UA-42483033-4', 'bpodgursky.com');
  ga('send', 'pageview');

</script>

</body>
</html>